---
title: 'The utility of spatial model-based estimators of unobserved bycatch: future
  or folly?'
author: Brian C. Stock^1^, Eric J. Ward^2^, James T. Thorson^3^, Jason E. Jannot^3^,
  Brice X. Semmens^1^
date: ''
output:
  word_document: default
  pdf_document:
    fig_caption: yes
    includes:
      in_header: options.sty
    keep_tex: yes
csl: ices-journal-of-marine-science.csl
bibliography: bycatch_simulation.bib
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=FALSE, tidy.opts=list(width.cutoff=60), warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = '../../' )
library(knitr)
library(tidyverse)
library(ggsidekick)
library(reshape2)
library(viridis)
library(date)
library(gridExtra)
library(pander)
library(kableExtra)
library(png)
library(forcats)
```

$^1$+1 425 919 7879, b1stock@ucsd.edu, semmens@ucsd.edu, Scripps Institution of Oceanography, University of California, San Diego, La Jolla, California 92093 USA\
$^2$eric.ward@noaa.gov, Conservation Biology Division, Northwest Fisheries Science Center, National Marine Fisheries Service, National Oceanic and Atmospheric Administration, 2725 Montlake Blvd E, Seattle WA, 98112, USA\
$^3$james.thorson@noaa.gov, jason.jannot@noaa.gov, Fisheries Resource and Monitoring Division, Northwest Fisheries Science Center, National Marine Fisheries Service, National Oceanic and Atmospheric Administration, 2725 Montlake Blvd E, Seattle WA, 98112, USA\


## Abstract

Quantifying effects of fishing on non-targeted (bycatch) species is an important management and conservation issue. Bycatch estimates are typically calculated using data collected by on-board observers, but observer programs are costly and therefore often only cover a small percentage of the fishery. The challenge is then to estimate bycatch for the unobserved fishing activity. The status quo for most fisheries is to assume the ratio of bycatch-to-effort is constant and multiply this ratio times the effort in the unobserved activity (ratio estimator). We used a dataset with 100% observer coverage, 35,440 hauls from the U.S. West Coast groundfish trawl fishery, to evaluate the ratio estimator against methods that utilize fine-scale spatial information: generalized additive models (GAMs) and random forests. Applied to 15 species representing a range of bycatch rates, including spatial locations improved model predictive ability, whereas including effort-associated covariates generally did not. Random forests performed best for all species (lower root mean square error), but were slightly biased (overpredicting total bycatch). Thus, the choice of bycatch estimation method involves a tradeoff between bias and precision, and which method is optimal may depend on the species bycatch rate and how the estimates are to be used.

## Keywords

bycatch estimation, discards, ratio estimator, spatial model, fishing effort, GAM (generalized additive model), random forest, bias-variance tradeoff, U.S. West Coast groundfish fishery

## Introduction  
  
The incidental bycatch of non-targeted species by fisheries in the US and around the world has been highlighted as an issue of both conservation concern and fisheries inefficiency [@harrington2005], and reducing or eliminating bycatch and incidental mortality is a goal of many fisheries around the world. There are several reasons why a species might be considered bycatch or discarded: the species may be of little or no commercial value, the species may be protected (e.g. marine mammals, turtles, birds), the species may be permitted to be caught but in a different fishery, or the quota for the targeted species in a given time period may be exceeded. In addition to making fisheries more efficient, reducing bycatch can have positive socioeconomic benefits to fishers. Two such examples include: fisheries remaining open longer (before bycatch quotas are met), and valuable stocks rebuilding more quickly due to reductions in take of overfished bycatch species [@nmfs2016bycatch]. 

Quantifying the amount of bycatch or discards for a given fishery can be challenging. One of the most reliable sources of information is the use of onboard scientific observers. Because observer programs are typically expensive, few fisheries around the world are able to maintain 100% observer coverage. Instead, a subset of fishing activities (e.g. hauls or trips) is typically monitored. Assuming these observed units are representative of unobserved fishing, ratio estimators can be used to expand, or "raise", the observed bycatch ratio (i.e. the ratio of bycatch-to-effort) to the remainder of the fishery. In situations where bycatch rates are assumed to vary by strata (e.g. by season, depth, or latitude), the ratio estimator can be applied separately to each stratum and then summed to generate a total index of bycatch, 
$\sum_{ s=1 }^{ S }{ \frac { { d }_{ s } }{ { r }_{ s } }  } { R }_{ s }$, where ${ d }_{ s }$ is the observed bycatch or discards for stratum *s*, ${ r }_{ s }$ is the retained observed catch for stratum *s* and ${ R }_{ s }$ is the total landed catch in stratum *s* [@cochran1963]. Importantly, ratio estimators do not incorporate a formal underlying statistical model (i.e. are free of any assumptions regarding data structure), and are thus sample-based estimators, rather than model-based estimators [@mccracken2000]. These stratified ratio estimators are broadly used in fisheries worldwide---across regions, management organizations, and gear types---and applied to estimates of both discards and protected species takes (Table 1).

Despite their widespread use, there are a number of potential issues in applying ratio estimators to enumerate fleet-level bycatch. First, using observed catches of target species or any other measure of effort implicitly makes an assumption about a linear relationship between non-target and target catches [@fonteneau2003]. This may be unrealistic, particularly as the distribution of catches of non-target species is often zero-inflated, or has a small number of observations containing extremely high values [@ortiz2004; @rochet2005]. Second, multiple variables are often available to expand, or raise, bycatch estimates from the observed units to the fleet-level (e.g. target catch and effort metrics like duration, gear size, and engine size), and using different variables can result in very different estimates [@ices2007; although @wigley2007 found choice of raising variable to have little effect]. When stock assessments include these discard estimates, they can be very sensitive to the raising variable used [@ices2007]. Third, for species with low bycatch rates in fisheries with low observer coverage (i.e. rare-event bycatch), it is common for zero bycatch events to be observed in a given year (ratio estimator = 0), and when bycatch events are observed, the ratio estimator often delivers implausibly high estimates [@mccracken2004; @martin2015]. Fourth, the boundaries of strata used in a ratio estimator can be somewhat arbitrary whenever post-stratified boundaries are used (as is common in multispecies sampling designs). A final and related point is that within each stratum, bycatch rates are assumed to be uniform, while in reality they may vary by season, depth, or other factors. 

One of the biggest questions related to bycatch estimation is whether model-based estimators that incorporate explicit spatial information (beyond any implicit spatial information incorporated by strata) offer any advantage over the widely used stratified ratio estimator. Like fishery independent catch per unit effort (CPUE) data, fishery dependent bycatch patterns are spatially correlated [@lewison2009]. Accounting for spatial correlation in model-based estimators has been extensively summarized in the geostatistical literature [e.g. @brus1997; @grondona1991]. Similar comparisons have recently been applied to index standardization of fisheries survey data [@maunder2004]. In the majority of cases, spatially explicit model-based estimators have increased precision relative to simpler estimators that assign observations to strata [@thorson2013; @shelton2014; @thorson2015]. There are a number of additional advantages of spatial models, including the ability to better quantify shifts in distribution [@thorson2016], and improved ability to identify fine scale hotspots of high bycatch [@cosandey-godin2014; @ward2015]. While the majority of these recent analyses of fishery dependent data have relied on parametric methods [delta-GLMM models; @thorson2013], semi- or non-parametric models such as generalized additive models (GAMs) or random forests (RFs) have also been used to include spatial variation [@winker2013a; @li2015; @thorson2015].

While recent work has included fishing location information in spatial model-based estimates of bycatch [@orphanides2009], there is little guidance on how to model spatiotemporal variation, and how different spatial modeling approaches compare in their bias or precision against the traditional ratio estimator [GARFO -@garfo2016]. To evaluate these different bycatch estimators, we developed a simulation study from observer data collected from the West Coast Groundfish Observer Program (WCGOP) at the Northwest Fisheries Science Center. While observers have been monitoring a portion of trips in the groundfish fishery since 2002, since 2011 regulations require an observer on every groundfish trip (100% coverage). Thus, years with 100% coverage can be subsampled to generate smaller datasets that can be used to expand estimates to the fleet total, and the relative performance of different methods can be compared because the true bycatch is known. We begin by using the entirety of the dataset to test the ratio estimator assumption of a linear relationship between bycatch and available metrics of fishing effort. Next, we use randomly generated subsamples of the observer data to evaluate (1) the relative performance of spatial model-based bycatch estimates against the conventional stratified ratio estimator, (2) the value of including available covariates as continuous, nonlinear terms in the spatial models, as opposed to strata (i.e. factors), and (3) the sensitivity of model performance to varying levels of observer coverage.

## Methods

### Fisheries observer data

To evaluate the performance of ratio estimators versus spatial model-based estimates of fleet-wide bycatch, we used a dataset from the United States with 100% observer coverage, the West Coast Groundfish Observer Program (WCGOP) of the Northwest Fisheries Science Center [NWFSC, @bellman2010]. The WCGOP monitors commercial bottom trawls on the west coast of the USA, which primarily target groundfish such as Dover sole (*Microstomus pacificus*), thornyheads (*Sebastolobus spp.*), sablefish (*Anoplopoma fimbria*), and rockfish (*Sebastes spp.*). The fishery moved to an individual fishing quota (IFQ) system with 100% observer coverage in 2011, and we used the 35,440 post-IFQ hauls (4,007 trips) observed from 2011-2015 in the area north of Cape Falcon, Oregon (45.77° N, Fig. \ref{fig:effort}). In 2015, a small portion of the fleet began experimenting with the use of electronic monitoring equipment in lieu of an observer. We excluded any such trips from our analysis. For each haul, observers recorded haul duration, location, date, time, depth, gear type, and at-sea catch including at-sea discarded bycatch [for details see NWFSC -@nwfsc2016]. While trip is the primary sampling unit (i.e. observers are placed on vessels on a trip-by-trip basis, and then observe all hauls within the trip), the WCGOP records data and expands bycatch using the haul-level [@somers2018], unlike other observer programs that record and expand at the trip-level [@ices2007; @wigley2007]. Because fishermen are permitted to land a low quota of valuable non-target species under IFQ management, we only considered 15 species that are exclusively discarded and cover wide ranges of bycatch rates and levels of management concern (Table \ref{tab:species-list}). Species such as Dungeness crab or Pacific halibut are of high value, but as each are permitted in other fisheries, they are considered bycatch in the groundfish fishery.

### Relationship between bycatch and effort

Ratio estimators implicitly assume there is a linear relationship between non-target and target catches or other metric of fishing effort. The stratified ratio estimator typically involves multiplying the bycatch-to-target catch ratio by the total target catch within strata, although it is certainly possible to replace target catch with other metrics of effort, such as haul duration. This may be advantageous if a linear relationship exists between bycatch and haul duration, but not between bycatch and target catch. To investigate whether there was a linear relationship between bycatch and two available metrics of fishing effort, retained catch of target species (kg) and haul duration (minutes), we fit log-log linear models for each species:
$$ log(\text{Bycatch}) = \alpha + \beta \ log(\text{Effort}) + \epsilon$$
$$ \epsilon \sim \mathcal{N}(0,\,\sigma^{2})$$
The slope term, $\beta$, of a log-log linear model is the exponent of an assumed power law, i.e:
$$ \text{Bycatch} = e^\alpha \ \text{Effort}^{\beta} \ e^\epsilon$$
Thus, if a linear relationship between bycatch and fishing effort exists, the power law exponent should equal one ($\beta = 1$). Exponents greater than one ($\beta > 1$) imply positive concavity and exponents less than one ($\beta < 1$) imply negative concavity, while $\beta = 0$ if no relationship exists.

### Simulation design

We compared the performance of the stratified ratio estimator with two spatial modeling frameworks: GAM and RF. All analyses were conducted using R v3.4.4 [@rcoreteam2018], and code is available at https://github.com/brianstock/fleetwide. We designed our data sub-sampling experiment to calculate predictive performance by cross-validation. We generated 200 'training' datasets with reduced observer coverage (e.g. 20%, 40%), by sampling trips (collections of hauls) without replacement from the complete dataset. We used trip as the cross-validation sample unit because this mirrors sampling schemes in observer programs with less than 100% coverage (i.e. observers are placed on vessels on a trip-by-trip basis, and then observe all hauls within the trip). Note that while trip is the WCGOP sampling unit and used to construct the train/test splits, the data are collected at the haul-level and we model the haul-level data directly. This blocking procedure accounts for the correlation of hauls within trips to avoid negative bias in our cross-validated estimates of model performance [@roberts2017]. These training datasets were generated once for all species, so that models were evaluated against the same simulated datasets. Hauls from unobserved trips were then used as the 'test' dataset to evaluate predictions. This repeated training/test split procedure is also known as "leave-group-out cross-validation" or "Monte Carlo cross-validation," and a set of 200 train/test splits is recommended as a good sample size [@kuhn2013]. 

#### Status quo: stratified ratio estimator

We implemented the stratified ratio estimator as described in the Introduction, where the observed bycatch-to-target catch ratio is multiplied by the target catch of unobserved hauls in each strata, and total estimates are generated as sums over strata [@cochran1963]. Motivated by @bellman2010 and @somers2018, we stratified the ratio estimator by year (five levels: 2011, 2012, 2013, 2014, 2015), bimonthly period (six levels: Jan-Feb, Mar-Apr, ... , Nov-Dec), and depth (three levels: 0-125, 126-250, > 250 fathoms). Any stratum with zero sampled bycatch was expanded to predict zero total bycatch in that stratum.

#### Spatial framework #1: generalized additive models (GAMs)

We compared the stratified ratio estimator with GAMs using two alternative methods of accounting for zeros. Our first approach, the "GAM-Delta" model, partitioned the bycatch data into separate presence/absence ('binomial') and 'positive' components [a delta, or hurdle, model as in @pennington1983; @maunder2004]. The GAM-Delta model estimates of total density were then calculated by multiplying the binomial and positive components [as in @lo1992]. The second approach, the "GAM-Total" model, treats zero inflated catch data as arising from a Tweedie distribution with power parameter $1 < p < 2$, which is a compound Poisson process where catch is modeled as the sum of $N$ independent gamma random variables, with $N$ following a Poisson distribution [@tweedie1984]. Assuming a Tweedie distribution is reasonable, as the haul catch (weight) can be thought of as a sum of the weight of $N$ fish, where the weight of each fish is gamma-distributed [@candy2004]. Importantly, this allows for hauls with zero catch, since $N$ can be zero. We estimated the Tweedie power parameter, $p$, for each species outside the model using maximum likelihood, and then fit GAMs using these fixed, species-specific $p$ values.

We designed the GAM-Delta and GAM-Total models to mimic the stratified ratio estimator for two reasons. First, we sought a direct comparison between the ratio estimator and GAMs. Second, we aimed to inform the process of producing yearly bycatch estimates for dozens of species in a highly multispecies trawl fishery, where lengthy model selection is impractical given current logistical constraints [@bellman2010; @somers2018]. Given these goals, we treated year, season, and depth interval as factors (akin to strata). Bimonthly period was included as a second-order polynomial to avoid confounding with factor(season). We included retained target catch (kg) as a linear term because the ratio estimator assumes this to be true. Spatial fishing locations were included by adding a 2D thin plate regression spline on latitude and longitude:

$$ \text{Bycatch} \sim factor(\text{Year}) + factor(\text{Season}) + \text{Bimonth} + \text{Bimonth}^2 + factor(\text{Depth interval}) + \text{Catch} + \text{s}(\text{Lat}, \text{Long}) $$

Tensor product splines were also considered for the 2D spline, since they are designed for cases where the scale differs in the two dimensions (as in our case, along- vs. cross-shore distance). We used thin plate regression splines instead, however, because they had better predictive performance in preliminary testing.

Finally, we fit a third GAM that incorporated all available covariates with nonlinear flexibility, "GAM-Nonlinear". We expected GAM-Nonlinear to outperform the GAM-Delta and GAM-Total models because, presumably, explanatory power is lost by not including covariates (gear type, hour of day) and stratifying by depth (to depth interval), date (to season and bimonthly period), and location (areas by latitude). GAM-Nonlinear used the same Tweedie distribution and 2D spatial spline as the GAM-Total model, so any performance difference would demonstrate the value of including available covariates as continuous, nonlinear terms in the spatial models instead of as factors (i.e. strata). We included year, Julian day of year, hour of day, and depth as 1D splines. Gear type was treated as a factor since it was a categorical variable.

$$ \text{Bycatch} \sim s(\text{Year}) + s(\text{Julian day}) + s(\text{Hour}) + s(\text{Depth}) + \text{Gear} + \text{Catch} + \text{s}(\text{Lat}, \text{Long}) $$

#### Spatial framework #2: random forests (RFs)

We fit three random forest models as direct analogues to the GAMs. "RF-Delta" considered the binomial and positive data independently and multiplied them together to calculate total bycatch density, as in GAM-Delta. "RF-Total" treated the binomial and positive data as occurring from the same process in a single model, as in GAM-Total. 

As for their GAM analogues, RF-Delta and RF-Total were restricted to using the same factor covariates as the stratified ratio estimator, plus latitude and longitude. By their nature, random forests include interactions between covariates and treat continuous covariates as nonlinear [@breiman2001; @biau2016]. Thus, we simply included latitude and longitude in the RF models to estimate a spatial effect.

$$ \text{Bycatch} \sim factor(\text{Year}) + factor(\text{Season}) + \text{Bimonth} + \text{Bimonth}^2 + factor(\text{Depth interval}) + \text{Catch} + \text{Lat} + \text{Long} $$

Similar to GAM-Nonlinear, we fit a third RF model with all available covariates and nonlinear flexibility. Since RFs are claimed to not overfit data [@breiman2001] and suffer less from incorporating numerous, possibly correlated and uninformative covariates [@biau2016], we expected RF-Nonlinear to have the lowest prediction error.

$$ \text{Bycatch} \sim \text{Year} + \text{Julian day} + \text{Hour} + \text{Depth} + \text{Gear} + \text{Catch} + \text{Lat} + \text{Long} $$

Lastly, we fit four variations of each GAM and RF model to determine the effect of including location and effort (target catch) on predictive performance: no effort or location, location only, effort only, and both location and effort. GAMs were fit using 'mgcv' [v1.8-17, @wood2006], and RFs were fit using 'randomForest' [v4.6-12, @liaw2002]. Figure \ref{fig:model-descriptions} displays all model formulas and uses fits to Pacific Hake bycatch to illustrate how each model treated the covariates differently.

### Model evaluation

For each simulated dataset, we calculated model performance as root mean square error (RMSE) using the predicted and observed bycatch. RMSE was calculated by year, and also averaged across years. As RMSE can be expressed as the sum of variance and squared bias, we also generated estimates of the bias from each prediction, in order to better understand the relative contributions to total RMSE (in other words, why some models do better than others).

## Results

### Weak relationship between effort and bycatch

For nearly all of the 15 species included in our analysis, we found that relationships between bycatch and the two effort (both target catch and haul duration) were either weak or nonlinear, as most power law exponents from the log-log regression were much less than 1 (25/30 < 0.5, Figs. \ref{fig:effort-bycatch-slopes}, \ref{fig:effort-bycatch}, and S1). In only a few cases were the estimated coefficients close to 1.0 (the relationship assumed when effort is included as an offset).

### Model comparison: RF had lower error but slight bias

Compared to the ratio estimator, we found that all of the RF models produced estimates of total bycatch that had lower RMSE (26% lower averaged across species, Fig. \ref{fig:model-comparison}). For most species and years, median bycatch estimates from the ratio estimator and RF-Nonlinear were close to each other and the true, observed bycatch, but the RF model was more precise (Fig. \ref{fig:model-comparison-byyear-catch}). However, RF-Nonlinear had higher bias compared to the ratio method (median percent error across all species and years: RF = 0.078, GAM = 0.026, Ratio = -0.002, Fig. \ref{fig:model-comparison-byyear}). The GAM-Delta and GAM-Total models appeared to have convergence issues for some simulations in one-fifth of the species (Black skate, California slickhead, and Grenadier), but GAM-Nonlinear did not. In relation to the ratio estimator and RF models, the performance of GAM-Nonlinear was intermediate both in terms of accuracy and bias (Figs. \ref{fig:model-comparison} and \ref{fig:model-comparison-byyear}). Spatial terms in the GAM models were significant and generally consistent with those estimated by RF (Supplemental Article S1).

Though delta models have been widely used in the index standardization of fisheries data [@maunder2004], both GAM and RF models with an aggregated response consistently outperformed delta models (Fig. \ref{fig:model-comparison}).

### Effect of including fishing effort and spatial locations

We found minimal gain in predictive performance when fishing effort was included as a covariate. In all models compared, any effect of effort was smaller than the effect of including spatial locations (Fig. S2). An important difference between the GAM and RF models was that for many species, adding spatial locations to GAMs led to worse predictions, while adding location information to the RF models either improved predictions (especially for RF-Delta) or had no effect.

### Influence of data richness on model performance

As expected, model performance improved for higher observer coverage (20% vs. 40%, Fig. S3). Averaged across species, RF had markedly lower median RMSE than the ratio estimator. In fact, the RF models based on 20% observer coverage (0.155 median RMSE) outperformed the ratio estimator based on 40% observer coverage (0.180 median RMSE). Similarly, the performance advantage (indicated by lower RMSE) of RF over the ratio estimator was most pronounced for species with low bycatch rates, and decreased for species with higher bycatch rates (Fig. \ref{fig:bycatch-rate-rmse}).

## Discussion

In terms of the relative performance across models, our results are consistent with previous studies showing that non-parametric methods such as random forests offer improved predictive capabilities over GAMs and delta-GLMM models [@rooper2017; @marmion2009; @knudby2010]. Including spatial locations of fishing offered a considerable improvement in RMSE for many species, particularly in the RF-Delta model (Fig. S2). However, once spatial information was included, the addition of effort had a minimal effect in reducing RMSE. This result is not surprising, given the weak relationships between bycatch and effort revealed by our log-log analyses (Figs. \ref{fig:effort-bycatch-slopes}, \ref{fig:effort-bycatch}, and S1). We found decreases in RMSE for all species and models as observer coverage increased from 20% to 40% (Fig. S3). The improvement in predictive capabilities with increasing observer coverage is consistent with previous simulation experiments using different fisheries [@amande2010b; @babcock2003]. 

This analysis is based on one fishery and does not demonstrate that spatial model-based estimators will necessarily outperform ratio estimators in all fisheries. Several factors likely influence the degree to which a fishery may benefit from a spatial model-based estimate versus a ratio estimator. For instance, future work could compare these simulation results with those from another fishery with more complex spatial effort patterns. The West Coast groundfish trawl fishery has a relatively simple, depth-based spatial effort distribution (Fig. \ref{fig:effort}), and the WCGOP currently stratifies the ratio estimator by depth. The fact that the spatial models outperformed the ratio estimator in a spatially simple, well-stratified scenario leads us to speculate that other fisheries with more complex spatial effort patterns (less amenable to stratification) likely have even more to gain from using spatial model-based estimates. We also expect more improvement (reduction in RMSE) for fisheries and species with lower bycatch rates (Fig. \ref{fig:bycatch-rate-rmse}) and lower observer coverage (Fig. S3)

For an observer program tasked with producing yearly bycatch estimates for many species, the ideal bycatch estimation model is simple, converges rapidly, performs well on average, and never performs much worse than a default option like a ratio estimator. Therefore, the fact that all three RF models had equal or lower prediction error than the ratio estimator across all species and scenarios is an important finding. The desire for one simple model also informed our selection of candidate models; we did not test an exhaustive list of modeling options for spatiotemporal bycatch data, but a subset of models that analysts are familiar with and can apply quickly. We assumed that each species in our simulations were affected by the same set of covariates; ideally, a single best model could be developed for each species in a given fishery, with unique covariates.

The second important finding from our simulations with practical implications for management is that the choice of one estimator over another is accompanied by an implicit tradeoff between bias and variance. While RF had equal or lower prediction error than the ratio estimator for all species, RF was slightly biased high (overestimating true bycatch, Fig. \ref{fig:model-comparison-byyear}). On the other hand, RF estimates were much less variable than the ratio estimator. This bias-variance tradeoff was apparent for all species in our simulations (Fig. \ref{fig:variance-bias}), but depended on the species' bycatch rate (Fig. \ref{fig:bycatch-rate-rmse}). For commonly-caught species like Sandpaper Skate or Brown Cat Shark, where RF and the ratio estimator had similar RMSE, RF offered slight reductions in uncertainty but had large increases in bias. For rarely-caught species, like California Slickhead or Dungeness Crab, RF exchanged large reductions in uncertainty for modest increases in bias. The recommendation of one methodology over another largely depends on what the bycatch estimates will be used for. Stock assessment scientists, for example, may be primarily interested in unbiased but imprecise estimates, such as the ratio estimator, which can then be fitted and smoothed statistically during model fitting. On the other hand, scientists or policy makers who are more concerned about relative changes in bycatch over time may prefer more precise estimators (such as RFs or GAMs) that are more robust to noise arising from sampling less than 100% of the fishery. We recommend further research regarding circumstances when it is important to minimize bias versus imprecision when processing data for inclusion in a second-stage model [@szpiro2013].

The bias of a RF model is roughly equal to the bias of the individual regression trees it comprises, so it should not be expected to produce unbiased estimates [@breiman1999; @kuhn2013; @xu2013]. RF bias depends on the response variable distribution--RF will be unbiased for a uniform response, and we can expect positive bias for typical fisheries catch distributions (positive, right-skewed). Why? Consider how each individual tree in a RF generates predictions for the tails of a distribution. Terminal nodes for extreme values use the mean of the training data in those nodes, so trees tend to overpredict in the lower tail and underpredict in the upper tail. Because bycatch is right-skewed, there are more observations in the lower tail, and therefore more overprediction than underprediction. Several bias correction methods have been proposed, and we tested two: 1) Cubist, which fits a linear model in terminal nodes instead of using the data mean [@quinlan1992; @quinlan1993], and 2) @xu2013, which fits a second RF model to the residuals of the original RF. Unfortunately, Cubist reduced but did not eliminate bias, and @xu2013 performed poorly (e.g. for Dungeness crab, Cubist reduced median percent error from 0.055 to 0.043, Fig. S4).

Based on the results from our simulation study, there are several potential avenues of future research that will help to advance the inclusion of spatial information into bycatch estimation. First, additional work could be done to improve variance estimation for non-parametric methods such as RF. Resampling or bootstrapped estimates could be generated for fisheries with less than 100% observer coverage, and variance estimates could be compared to analytic estimates via the ratio estimator [@cochran1963]. Second, it may be useful to perform a more detailed comparison between the models used here, and the spatiotemporal delta-GLMM models that have been widely used for fisheries survey data [@thorson2015]. Similarly, multispecies spatiotemporal models may improve predictions of local density by sharing information about underlying spatial patterns [@latimer2009; @warton2015; @ovaskainen2016; @thorson2017; @thorson2017vast]. Additionally, advice on the number and distribution of knots or random effects in spatiotemporal models would be useful for analysts interested in applying these models.

## Supplementary material

The following supplementary material is available online:

Table S1: Annual bycatch (mt) and bycatch rate (percent of hauls) for species selected from the U.S. WCGOP dataset.

Figure S1: Estimated relationships between fishing effort (haul duration in hours) and bycatch (kg) for 15 species analyzed in the West Coast groundfish trawl fishery.

Figure S2: Change in predictive performance (normalized RMSE) when adding fishing effort and spatial location as covariates in each model.

Figure S3: Predictive performance (normalized RMSE) for different levels of simulated observer coverage.

Figure S4: Performance of RF bias correction methods (percent error, PE, averaged across years 2011-2015).

Article S1: RF and GAM model formulas, summaries, and plots of covariate effects for all 15 WCGOP species.

## Acknowledgements
BCS received support from the National Science Foundation Graduate Research Fellowship under Grant No. DGE-1144086, as well as a Graduate Research Internship Program allowance. The authors thank the WCGOP staff at the NWFSC, and the dedicated observers who made this work possible.   

## References

<div id="refs"></div>

\pagebreak
\begin{landscape}

\begin{table}[]
\caption{Fisheries for which the ratio estimator is used to calculate total bycatch from partial observer coverage. This list is far from comprehensive and included simply to illustrate broad use of the ratio estimator across fisheries regions, management organizations, and gear types.}
\label{ratio-ex}
\begin{tabular}{@{}llllll@{}}
\toprule
\renewcommand{\arraystretch}{1.2}\textbf{FAO Region} & \textbf{\begin{tabular}[c]{@{}l@{}}Country/\\ Organization\end{tabular}} & \textbf{Fisheries} & \textbf{Bycatch Species} & \textbf{\begin{tabular}[c]{@{}l@{}}Observer\\ Coverage\end{tabular}} & \textbf{Reference} \\
\midrule
Global & FAO & All & Total bycatch (all species combined) &  & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Alverson et al. 1994,\\ Kelleher 2005\end{tabular}\renewcommand{\arraystretch}{1.2} \\
Mediterranean Sea & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Spain, Italy,\\ Greece, Turkey\end{tabular}\renewcommand{\arraystretch}{1.2} & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Trawl, trap, purse seine,\\ longline, dredge, gillnet\end{tabular}\renewcommand{\arraystretch}{1.2} & Total bycatch (all species combined) &  & Tsagarakis et al. 2014 \\
\renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Mediterranean Sea\\ Atlantic, Northeast\end{tabular}\renewcommand{\arraystretch}{1.2} & European Union & All & All &  & ICES 2007 \\
Atlantic, Northeast & Scotland & Seine, trawl & Haddock, cod, whiting & 0.1-0.2\% & Stratoudakis et al. 1999 \\
Atlantic, Northeast & Ireland & Gillnet (albacore tuna) & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}25 species of fish, seabirds,\\ turtles, and cetaceans\end{tabular}\renewcommand{\arraystretch}{1.2} & 2.2-47.8\% & Rogan and Mackey 2007 \\
Atlantic, Northwest & USA & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Longline, trawl, seine,\\ pot/trap, handline, \\ dredge, gillnet\end{tabular}\renewcommand{\arraystretch}{1.2} & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}60 species of groundfish, invertebrates,\\ pelagic fish, elasmobranchs, seabirds,\\ marine mammals, and turtles\end{tabular}\renewcommand{\arraystretch}{1.2} & 3\% & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Wigley et al. 2007,\\ GARFO 2016\end{tabular}\renewcommand{\arraystretch}{1.2} \\
Atlantic, Northwest & Canada & Longline, trawl, gillnet & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Porbeagle, shortfin mako shark,\\ blue shark\end{tabular}\renewcommand{\arraystretch}{1.2} & 5\% & Compana et al. 2011 \\
Atlantic, Western & USA & Shrimp trawl & Marine mammals & 0.8\% & Soldevilla et al. 2016 \\
Atlantic, Southeast & South Africa & Groundfish trawl & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}19 species of finfish, elasmobranchs,\\ and cephalopods\end{tabular}\renewcommand{\arraystretch}{1.2} & 0.3\% & Walmsley et al. 2007 \\
Atlantic, all & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Spain, France,\\ ICCAT\end{tabular}\renewcommand{\arraystretch}{1.2} & Tuna purse seine & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Dozens of species of other finfish, sharks,\\ marine mammals, and turtles\end{tabular}\renewcommand{\arraystretch}{1.2} & 1.5-32.7\% & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Amande et al. 2010b,\\ Hall and Roman 2013\end{tabular}\renewcommand{\arraystretch}{1.2} \\
Indian, all & Taiwan & Longline & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}40 species of tuna, fish, sharks,\\seabirds, marine mammals, and turtles\end{tabular}\renewcommand{\arraystretch}{1.2} & 2.2-20.8\% & Huang and Liu 2010 \\
Indian, all & IOTC & Tuna purse seine & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Dozens of species of tuna, other finfish,\\ sharks, marine mammals, and turtles\end{tabular}\renewcommand{\arraystretch}{1.2} & 1.4-8.1\% & Hall and Roman 2013 \\
Indian, Western & Kuwait & Shrimp trawl & 23 species of finfish and elasmobranchs & 35-54\% & Ye et al. 2000 \\
Pacific, Southwest & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}New Zealand,\\ Australia\end{tabular}\renewcommand{\arraystretch}{1.2} & Deepwater trawl & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}48 species of finfish, elasmobranchs,\\ and invertebrates\end{tabular}\renewcommand{\arraystretch}{1.2} & 10.5-22.1\% & Anderson and Clark 2003 \\
Pacific, Eastern & IATTC & Tuna purse seine & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Dozens of species of tuna, other finfish,\\ sharks, marine mammals, and turtles\end{tabular}\renewcommand{\arraystretch}{1.2} & \textgreater 99\% & Hall and Roman 2013 \\
Pacific, Western & WCPFC & Tuna purse seine & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Dozens of species of tuna, other finfish, \\ sharks, marine mammals, and turtles\end{tabular}\renewcommand{\arraystretch}{1.2} & 1.5-11\% & Hall and Roman 2013 \\
Pacific, Eastern & USA & Groundfish trawl & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Dozens of species of finfish, elasmobranchs,\\ invertebrates, marine mammals, and seabirds\end{tabular}\renewcommand{\arraystretch}{1.2} & \textgreater 99\% & Somers et al. 2018 \\
Pacific, Eastern & USA & Sablefish longline & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Dozens of species of finfish, elasmobranchs,\\ invertebrates, marine mammals, and seabirds\end{tabular}\renewcommand{\arraystretch}{1.2} & 7-41\% & Somers et al. 2018 \\
Pacific, Eastern & USA & Groundfish pot & \renewcommand{\arraystretch}{0.8}\begin{tabular}[c]{@{}l@{}}Dozens of species of finfish, elasmobranchs,\\ invertebrates, marine mammals, and seabirds\end{tabular}\renewcommand{\arraystretch}{1.2} & 2-12\% & Somers et al. 2018 \\
\bottomrule
\end{tabular}
\end{table}

\end{landscape}

---
nocite: | 
  @somers2018,
  @garfo2016,
  @wigley2007,
  @stratoudakis1999,
  @soldevilla2016,
  @campana2011,
  @huang2010,
  @ye2000,
  @walmsley2007,
  @kelleher2005,
  @alverson1994,
  @hall2013,
  @tsagarakis2014,
  @ices2007
...

\pagebreak

```{r species-list, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
allyears = readRDS("figures/table1_summary_byspecies/allyears.rds")
      
kable(allyears, "latex", booktabs = T, caption="\\label{tab:species-list}Total bycatch (mt) and bycatch rate (percent of hauls) for species selected from the U.S. West Coast Groundfish Observer Program (WCGOP) dataset. All selected species are exclusively discarded. The summarized data are 35,440 post-IFQ hauls (4,007 trips) observed from 2011-2015 in the area north of Cape Falcon, Oregon (45.77° N).") %>%
  kable_styling(latex_options=c("basic"))
```

\pagebreak

<!-- Figure 1, uses raw data so code not included here -->
<!-- https://www.zevross.com/blog/2017/06/19/tips-and-tricks-for-working-with-images-and-figures-in-r-markdown-documents/ -->
```{r effort, echo=FALSE, message=FALSE, warnings=FALSE, out.width="2.5in", fig.align = "center", fig.cap="Fishing effort density in the West Coast groundfish trawl fishery from 2011 to 2015 in the area north of Cape Falcon, Oregon (45.77° N). The West Coast Groundfish Observer Program monitored and collected data from 35,440 hauls from all (100\\%) of the 4,007 trips. Fishing effort was smoothed using a bivariate kernel density estimate ('bkde2D' function in R package 'KernSmooth') to ensure that fishing locations were anonymized."}
# fig1_path <- "figures/fig1_effort_density/fig1_effort_density.png"
fig1_path <- "../../figures/fig1_effort_density/fig1_effort_density.png"
# fig1 <- readPNG(fig1_path, native = TRUE, info = TRUE)
knitr::include_graphics(fig1_path)
```

\pagebreak

```{r model-descriptions, echo=FALSE, message=FALSE, warnings=FALSE, out.width="170mm", fig.align = "center", fig.cap="Summary of models fit to the West Coast Groundfish Observer Program bycatch dataset. The ratio estimator was stratified by Year, Bimonthly period, and Depth (fathoms). The Delta and Total models were fit to the same covariates, meant to mimic the stratified ratio estimator. Covariates treated as factors are indicated by \\textit{fac}(). The Delta models split the bycatch data into presence/absence (Y) and positive catches (Z), then calculate bycatch as Y x Z. The Nonlinear models incorporate all available covariates using nonlinear terms, e.g. spline terms in GAMs, \\textit{s}(). Covariate effect plots are shown for models fit to Pacific Hake bycatch (see Supplement for 14 other species and complete model statistics). We used the following R packages: 'mgcv' to fit GAMs, 'visreg' to visualize GAM covariate effects, 'randomForest' to fit RFs, and 'forestFloor' to visualize RF covariate effects."}
fig_path <- "../../figures/model_descriptions.pdf"
knitr::include_graphics(fig_path)
```

\pagebreak

<!-- uses raw data so code not included here -->
```{r effort-bycatch-slopes, echo=FALSE, message=FALSE, warnings=FALSE, out.width="6in",fig.align = "center", fig.cap="Estimated relationships between fishing effort, defined as haul duration (hours, left panel) or catch of target species (kg, right panel), and bycatch for 15 species analyzed in the West Coast groundfish trawl fishery. The slope terms, $\\beta$, of log-log linear models are exponents of an assumed power law fit to each species, $\\text{Bycatch} = \\alpha \\text{Effort}^{\\beta}$, with 95\\% CIs shown for each estimate. Most $\\beta$ are much less than 1 (left of dashed line), indicating the relationship between bycatch and effort is either weak or less-than-linear. Data ($n = 35,440$) consist of observed hauls from the West Coast Groundfish Observer Program recorded from 2011 to 2015 in the area north of Cape Falcon, Oregon (45.77° N)."}
# fig2_path <- "figures/fig2_effort_bycatch/fig2_effort_bycatch_target_nozeros.png"
fig_path <- "../../figures/fig2_effort_bycatch/fig2_effort_bycatch_caterpillar.png"
# fig1 <- readPNG(fig1_path, native = TRUE, info = TRUE)
knitr::include_graphics(fig_path)
```

\pagebreak

<!-- Figure 3, uses raw data so code not included here -->
```{r effort-bycatch, echo=FALSE, message=FALSE, warnings=FALSE, out.width="6in", fig.align = "center", fig.cap="Relationship between fishing effort (catch of target species in kg) and bycatch (kg) of 15 selected species in the West Coast groundfish trawl fishery. The slope terms, $\\beta$, of log-log linear models are exponents of an assumed power law fit to each species, $\\text{Bycatch} = \\alpha \\text{Effort}^{\\beta}$. All $\\beta$ are much less than 1, indicating the relationship between Bycatch and Effort is either weak or less-than-linear. Each data point ($n = 35,440$) is an observed haul from the West Coast Groundfish Observer Program recorded from 2011 to 2015 in the area north of Cape Falcon, Oregon (45.77° N)."}
# fig2_path <- "figures/fig2_effort_bycatch/fig2_effort_bycatch_target_nozeros.png"
fig2_path <- "../../figures/fig2_effort_bycatch/fig2_effort_bycatch_target_nozeros.png"
# fig1 <- readPNG(fig1_path, native = TRUE, info = TRUE)
knitr::include_graphics(fig2_path)
```

\pagebreak

```{r model-comparison, echo=FALSE, message=FALSE, warnings=FALSE, fig.height=8, fig.width=9, fig.align = "center", fig.cap="Predictive performance of the ratio estimator (status quo) and two spatial modeling frameworks: generalized additive models (GAMs) and random forests (RFs). We fit each model to 200 'training' datasets simulated with 20\\% observer coverage, then predicted bycatch in unobserved hauls to calculate annual estimates of fleet-wide bycatch. We calculated model performance (RMSE) using the true, observed bycatch. For each species, the dashed line indicates the median RMSE for the ratio estimator, and solid lines indicate median RMSE for each model. GAM-Nonlinear clearly outperformed GAM-Delta and GAM-Total, which had convergence issues for 3/15 species. The RF models all performed similarly and had higher accuracy than the ratio estimator for all species, on average having 26\\% lower RMSE (RF = 0.16, Ratio = 0.22)."}
dat = readRDS("figures/results_summary_depthratio.rds")
dat <- filter(dat, !(model %in% c("RF Cubist","RF Xu2","RF Xu4")))
dat$model <- as.character(dat$model)

# for now we'll only plot the simulations with 20% coverage
dat = filter(dat, pct_trips==0.2)

# facet by species. model options are including space, effort, both, neither (color)
dat$Covariate = paste(dat$spatial, dat$effort)
dat$Covariate[which(dat$Covariate==" ")] = "Neither"
dat$Covariate[which(dat$Covariate=="SP EFF")] = "Space, Effort"
dat$Covariate[which(dat$Covariate=="SP ")] = "Space"
dat$Covariate[which(dat$Covariate==" EFF")] = "Effort"

sp.labs <- levels(dat$species)
sp.labs[3] <- "Brown catshark"
dat$species <- as.character(dat$species)
dat.allspecies <- dat
dat.allspecies$species = "AVERAGE"
dat.all <- rbind(dat, dat.allspecies)
dat.all$species <- factor(dat.all$species, levels = c(sp.labs,"AVERAGE"))

filter_dat = group_by(dat.all, species, model, Covariate) %>% 
  mutate(rmse = ifelse(rmse > 10, NA, rmse)) %>% 
  ungroup() %>% 
  group_by(species) %>% 
  mutate(max_rmse = max(rmse,na.rm=T))
filter_dat$delta <- as.numeric(grepl("Delta", filter_dat$model))
filter_dat$delta <- factor(filter_dat$delta,labels=c("Non-delta","Delta"))

dat.spatial.eff <- filter(filter_dat, Covariate=="Space, Effort") %>% mutate(medRatio = NA) %>%
                    filter(model %in% c("GAM Delta", "GAM", "GAM Nonlinear", "RF Delta", "RF", "RF Nonlinear"))
dat.ratio <- filter(filter_dat, model=="Ratio") %>% group_by(species) %>% mutate(medRatio = median(rmse,na.rm=T))
dat.plot <- rbind(dat.spatial.eff, dat.ratio)
dat.plot$model <- factor(dat.plot$model, levels = c("Ratio", "GAM Delta", "GAM", "GAM Nonlinear","RF Delta", "RF", "RF Nonlinear"))
levels(dat.plot$model) <- c("Ratio", "GAM Delta", "GAM Total", "GAM Nonlinear","RF Delta", "RF Total", "RF Nonlinear")
dat.plot$species <- factor(dat.plot$species, levels = c(sp.labs,"AVERAGE"))

print(dat.plot %>% 
  ggplot(aes(model, rmse, fill = model)) + 
  	geom_violin(draw_quantiles = c(0.5)) +
  	geom_hline(aes(yintercept = medRatio, group = species), linetype = 2) +
  	facet_wrap(~ species) + 
  	theme_sleek() + 
  	xlab("Model") + 
  	ylab("Normalized RMSE") + 
  	theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  	coord_cartesian(ylim = c(0,1)) +
	scale_fill_manual(name="Model",
	                  values=c("grey","#E69F0080","#E69F00",rgb(t(col2rgb("#E69F00")/1.2), maxColorValue=255),"#56B4E980","#56B4E9", rgb(t(col2rgb("#56B4E9")/1.2), maxColorValue=255))))
    # scale_fill_manual(name="Model",
    #                   labels=c("Ratio", "GAM Tweedie", "VAST", "RF Total"),
    #                   values=c("grey","#E69F00","#009E73","#56B4E9")))

#       GAM Delta GAM Nonlinear GAM Total Ratio RF Delta RF Nonlinear RF Total
# 0%         0.02          0.03      0.04  0.03     0.02         0.03     0.02
# 2.5%       0.07          0.07      0.07  0.07     0.05         0.06     0.06
# 5%         0.09          0.08      0.08  0.09     0.06         0.07     0.07
# 25%        0.15          0.13      0.14  0.15     0.10         0.11     0.11
# 50%        0.26          0.19      0.21  0.22     0.14         0.16     0.16
# 75%        0.50          0.31      0.34  0.33     0.22         0.24     0.23
# 95%        1.81          0.66      1.16  0.61     0.46         0.43     0.44
# 97.5%      2.94          1.23      2.98  0.74     0.57         0.49     0.57
# 100%       9.62          9.64      9.75  2.07     1.39         0.89     1.62

```

\pagebreak

\begin{landscape}
```{r model-comparison-byyear-catch, echo=FALSE, message=FALSE, warnings=FALSE, out.width='10in',fig.height=7, fig.width=10, fig.align = "center", fig.cap="Predictive performance of the ratio estimator (status quo) and two spatial modeling frameworks: generalized additive models (GAMs) and random forests (RFs). We fit each model to 200 'training' datasets simulated with 20\\% observer coverage, then predicted bycatch in unobserved hauls to calculate annual estimates of fleet-wide bycatch. For each species and year, the dashed lines indicate the true observed bycatch. RF estimates were more precise (less variable) but also more biased. RF bias was generally positive, especially in years with below average bycatch (e.g. 2015 for most species)."}
dat = readRDS("figures/results_summary_depthratio.rds")
dat <- filter(dat, !(model %in% c("RF Cubist","RF Xu2","RF Xu4")))
dat$model <- as.character(dat$model)

# for now we'll only plot the simulations with 20% coverage
dat = filter(dat, pct_trips==0.2)

# facet by species. model options are including space, effort, both, neither (color)
dat$Covariate = paste(dat$spatial, dat$effort)
dat$Covariate[which(dat$Covariate==" ")] = "Neither"
dat$Covariate[which(dat$Covariate=="SP EFF")] = "Space, Effort"
dat$Covariate[which(dat$Covariate=="SP ")] = "Space"
dat$Covariate[which(dat$Covariate==" EFF")] = "Effort"

filter_dat = dat %>% 
  group_by(species) %>% 
  mutate(max_rmse = max(rmse,na.rm=T))
filter_dat$delta <- as.numeric(grepl("Delta", filter_dat$model))
filter_dat$delta <- factor(filter_dat$delta,labels=c("Non-delta","Delta"))

dat.spatial.eff <- filter(filter_dat, Covariate=="Space, Effort") %>% 
  filter(model %in% c("Ratio", "GAM Nonlinear", "RF Nonlinear"))
dat.ratio <- filter(filter_dat, model=="Ratio")
dat.plot <- rbind(dat.spatial.eff, dat.ratio)
dat.plot$model <- factor(dat.plot$model, levels = c("Ratio", "GAM Nonlinear", "RF Nonlinear"))

# gather annual estimates for UNOBSERVED bycatch
dat.plot <- as.data.frame(tidyr::gather(dat.plot, year, est_unobs, c("est_2011","est_2012","est_2013","est_2014","est_2015")))
dat.plot$year <- gsub("est_", "", dat.plot$year)
dat.plot$year <- as.factor(dat.plot$year)
dat.plot <- dat.plot %>% select(species, model, sim, year, est_unobs)

dat.true <- readRDS("wcgop data/true_bycatch_byyear.rds")
dat.true <- dplyr::mutate(dat.true, species = fct_recode(species, 
  "Big skate" = "big skate", "Black skate" = "black skate", 
  "Brown cat shark" = "brown cat shark", "California slickhead" = "california slickhead",
  "Dungeness crab" = "dungeness crab", "Grenadier" = "grenadier", 
  "Octopus" = "octopus unid", "Pacific hake" = "pacific hake",
  "Pacific halibut" = "pacific halibut", "Rosethorn rockfish" = "rosethorn rockfish",
  "Slender sole" = "slender sole", "Spiny dogfish shark" = "spiny dogfish shark",
  "Sandpaper skate" = "sandpaper skate", "Spotted ratfish" = "spotted ratfish",
  "Tanner crab" = "tanneri tanner crab"))
# for some reason rosethorn rockfish and sandpaper skate got mixed up in dat.true
dat.true$species <- as.character(dat.true$species)
dat.plot$species <- as.character(dat.plot$species)
sp.labs <- names(table(dat.plot$species))
dat.true$species <- factor(dat.true$species, levels=sp.labs)
dat.plot$species <- factor(dat.plot$species, levels=sp.labs)

# add true_obs and true_full to dat.plot (same for all models)
dat.plot <- dat.plot[with(dat.plot, order(model, species, year, sim)), ]
dat.true <- dat.true[with(dat.true, order(species, year, sim)), ] 
dat.plot$true_obs = NA
dat.plot$true_full = NA
dat.plot[dat.plot$model=="Ratio", c("true_obs","true_full")] <- dat.true[, c("true_obs","true_full")]
dat.plot[dat.plot$model=="RF Nonlinear", c("true_obs","true_full")] <- dat.true[, c("true_obs","true_full")]
dat.plot[dat.plot$model=="GAM Nonlinear", c("true_obs","true_full")] <- dat.true[, c("true_obs","true_full")]
dat.plot$est_full <- dat.plot$true_obs + dat.plot$est_unobs
dat.plot <- as.data.frame(dat.plot %>% group_by(species) %>% mutate(max_catch=max(true_full)) %>% 
            ungroup() %>% mutate(est_full_max=est_full/max_catch, true_full_max=true_full/max_catch))

print(dat.plot %>% 
  ggplot(aes(x=year, y=est_full_max, fill = model)) + 
    geom_boxplot(outlier.shape = NA) + 
    geom_errorbar(aes(ymax=true_full_max, ymin=true_full_max, group=interaction(species,year)), linetype=2) +
    facet_wrap(~ species) + 
    theme_sleek() + 
    xlab("Year") + 
    ylab("Relative bycatch (% of max by species)") + 
    coord_cartesian(ylim = c(0,1.2)) +
    scale_fill_manual(name="Model", labels=c("Ratio", "GAM Nonlinear", "RF Nonlinear"), values=c("grey","#E69F00","#56B4E9")))
```
\end{landscape}

\pagebreak

```{r model-comparison-byyear, echo=FALSE, message=FALSE, warnings=FALSE, out.width='6in',fig.height=3.75, fig.width=6, fig.align = "center", fig.cap="Percent error of annual bycatch predictions using the ratio estimator (status quo), GAMs, and random forests (RFs), averaged across 15 species in the West Coast groundfish trawl fishery. Averaged across species, RF-Nonlinear was the most precise model, followed by GAM-Nonlinear and the ratio estimator (median absolute percent error: RF = 0.121, GAM = 0.131, Ratio = 0.155). While the ratio estimator was unbiased, the two spatial model-based estimators exhibited positive bias, particularly RF (median percent error: RF = 0.078, GAM = 0.026, Ratio = -0.002). We fit each model to 200 'training' datasets simulated with 20\\% observer coverage, then predicted bycatch in unobserved hauls to calculate annual estimates of fleet-wide bycatch for each species. Percent error was calculated using the true, observed bycatch in each year."}
# created by /figures/summarize_results.R
# dat = readRDS("figures/results_summary.rds")
dat = readRDS("figures/results_summary_depthratio.rds") 
dat <- filter(dat, !(model %in% c("RF Cubist","RF Xu2","RF Xu4")))
dat$model <- as.character(dat$model)

# for now we'll only plot the simulations with 20% coverage
dat = filter(dat, pct_trips==0.2)

# facet by species. model options are including space, effort, both, neither (color)
dat$Covariate = paste(dat$spatial, dat$effort)
dat$Covariate[which(dat$Covariate==" ")] = "Neither"
dat$Covariate[which(dat$Covariate=="SP EFF")] = "Space, Effort"
dat$Covariate[which(dat$Covariate=="SP ")] = "Space"
dat$Covariate[which(dat$Covariate==" EFF")] = "Effort"

# Get ratio, VAST, RF results
dat$species <- as.character(dat$species)
# dat.vast <- filter(dat, Covariate=="Space") %>% filter(model %in% c("VAST"))
dat.spatial.eff <- filter(dat, Covariate=="Space, Effort") %>% filter(model %in% c("GAM Nonlinear","RF Nonlinear"))
dat.ratio <- filter(dat, model=="Ratio")

# Create ensemble = mean(VAST,RF)
# dat.ensemble <- dat.spatial.eff
err_cols <- c("e_2011","e_2012","e_2013","e_2014","e_2015","pe_2011","pe_2012","pe_2013","pe_2014","pe_2015")
# temp_array <- abind::abind(dat.vast[, err_cols], dat.spatial.eff[, err_cols], along=3)
# dat.ensemble[, err_cols] <- apply(temp_array, 1:2, mean, na.rm=T)
# dat.ensemble$model = "Ensemble"

# dat.plot <- rbind(dat.ratio, dat.vast, dat.spatial.eff, dat.ensemble)
# dat.plot$model <- factor(dat.plot$model, levels = c("Ratio", "VAST", "RF","Ensemble"))
dat.plot <- rbind(dat.ratio, dat.spatial.eff)
dat.plot$model <- factor(dat.plot$model, levels = c("Ratio","GAM Nonlinear","RF Nonlinear"))
dat.plot$species = "AVERAGE"

# filter_dat = dat %>% 
filter_dat = dat.plot %>% 
  # group_by(species, model, Covariate) %>% 
  # mutate(pe = ifelse(pe > 10, NA, pe)) %>%
  # ungroup() %>% 
  group_by(species) %>% 
  mutate(max_rmse = max(rmse,na.rm=T))
# filter_dat$delta <- as.numeric(grepl("Delta", filter_dat$model))
# filter_dat$delta <- factor(filter_dat$delta,labels=c("Non-delta","Delta"))

# dat.spatial.eff <- filter(filter_dat, Covariate=="Space, Effort") %>% mutate(medRatio = NA) %>%
#                     filter(model %in% c("Ratio", "RF Nonlinear"))
# dat.ratio <- filter(filter_dat, model=="Ratio") %>% group_by(species) %>% mutate(medRatio = median(rmse))
# dat.plot <- rbind(dat.spatial.eff, dat.ratio)
# dat.plot$model <- factor(dat.plot$model, levels = c("Ratio", "RF Nonlinear"))
# dat.plot$species <- factor(dat.plot$species, levels = c(sp.labs,"AVERAGE"))

# gather annual estimates
dat.plot <- as.data.frame(tidyr::gather(filter_dat, year, pe, c("pe_2011","pe_2012","pe_2013","pe_2014","pe_2015")))
dat.plot$year <- gsub("pe_", "", dat.plot$year)
dat.plot$year <- as.factor(dat.plot$year)
dat.plot$pe[dat.plot$pe > 10] <- 10

# pdf("figures/fig6_model_comparison_byyear/fig6_model_comparison_byyear_averagesp_ensemble.pdf", width=7, height=4)
print(dat.plot %>% #group_by(species, model) %>%
  ggplot(aes(x=year, y=pe, fill = model)) + 
    geom_violin(draw_quantiles = c(0.5)) +
    geom_hline(yintercept = 0, linetype = 2) +
    theme_sleek() + 
    xlab("Year") + 
    ylab("Percent Error") + 
    coord_cartesian(ylim = c(-0.75, 0.75)) +
    scale_fill_manual(name="Model", labels=c("Ratio", "GAM Nonlinear","RF Nonlinear"),
                    values=c("grey","#E69F00","#56B4E9")))
    # scale_fill_manual(name="Model", labels=c("Ratio", "VAST","RF Total","Ensemble"),
    #                 values=c("grey","#009E73","#56B4E9","white")))

# summarize bias
# dat.plot %>% group_by(model) %>% summarize(median.pe=median(pe,na.rm=T), median.abs.pe=median(abs(pe),na.rm=T))

#   model    median.pe median.abs.pe
# 1 Ratio     -0.002        0.155
# 2 GAM Nonlinear   0.0256          0.131
# 2 RF Nonlinear   0.0783          0.121
# 2 VAST      -0.113        0.141
# 3 RF Total   0.068        0.118
# 4 Ensemble  -0.013        0.104
```

\pagebreak

<!-- uses raw data so code not included here -->
```{r bycatch-rate-rmse, echo=FALSE, message=FALSE, warnings=FALSE, out.width="6in", fig.align = "center", fig.cap="RF reduction in prediction error compared to the ratio estimator, as a function of bycatch rate for 15 species in the U.S. West Coast groundfish trawl fishery. RF improved on the ratio estimator for all species (26\\% lower RMSE on average), but this improvement was greater for species with lower bycatch rates (e.g. Rosethorn rockfish, California slickhead, Big skate, Black skate, Dungeness crab, Grenadier)."}
fig_path <- "../../figures/supplement/fig10_bycatch_rate_rmse.png"
knitr::include_graphics(fig_path)
```

\pagebreak

<!-- uses raw data so code not included here -->
```{r variance-bias, echo=FALSE, message=FALSE, warnings=FALSE, out.width="6in", fig.align = "center", fig.cap="Bias-variance trade-off between the ratio estimator and RF. RF achieves more accurate predictions (lower RMSE) by allowing some bias but greatly reducing the variance of its estimates. The ratio estimator has very low bias but much higher variance (i.e. it underfits the data and is more sensitive to which hauls are observed). Dashed grey lines indicate iso-RMSE curves. Species with lines that are nearly parallel to the iso-RMSE curves (e.g. Octopus, Brown cat shark) indicate that RF and the ratio estimator perform similarly (same RMSE). Species with lines that cross iso-RMSE curves (e.g. Dungeness crab, California slickhead, Spiny dogfish shark) indicate RF greatly improves on the ratio estimator (lower RMSE). RF has lower RMSE for species with lower bycatch rates (Fig. 8)."}
fig_path <- "../../figures/supplement/fig7_tradeoffs_v2.png"
knitr::include_graphics(fig_path)
```

